// =====================================================
// File: iOS/AppDelegate.swift
// Target: iOS
// =====================================================

import UIKit
import UserNotifications
import FamilyControls
import WatchConnectivity

@main
final class AppDelegate: UIResponder, UIApplicationDelegate, UNUserNotificationCenterDelegate {

    func application(
        _ application: UIApplication,
        didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
    ) -> Bool {

        // 1. ØªÙØ¹ÙŠÙ„ WatchConnectivity
        _ = PhoneConnectivityManager.shared
        print("ðŸš€ WC Activated from AppDelegate (via Singleton init)")

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        let center = UNUserNotificationCenter.current()
        center.delegate = self
        
        // 3. Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        NotificationService.shared.requestPermissions()

        // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù† Ø¨Ø¹Ø¯
        application.registerForRemoteNotifications()

        return true
    }

    func applicationDidBecomeActive(_ application: UIApplication) {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø§Ø±Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Badge) Ø¥Ù„Ù‰ ØµÙØ± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        UIApplication.shared.applicationIconBadgeNumber = 0
    }

    func application(
        _ application: UIApplication,
        configurationForConnecting connectingSceneSession: UISceneSession,
        options: UIScene.ConnectionOptions
    ) -> UISceneConfiguration {
        let configuration = UISceneConfiguration(name: "Default Configuration", sessionRole: connectingSceneSession.role)
        configuration.delegateClass = SceneDelegate.self
        return configuration
    }

    // MARK: - Remote Notifications Registration

    // âœ… Ø¯Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø®Ø¯Ù…Ø©
    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        let tokenParts = deviceToken.map { data in String(format: "%02.2hhx", data) }
        let token = tokenParts.joined()
        print("âœ… Device Token Retrieved: \(token)")
        
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù†Ø±Ø³Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡
        SupabaseService.shared.updateDeviceToken(token)
    }

    // Ø¯Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    func application(_ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error) {
        print("âŒ Failed to register for remote notifications: \(error)")
    }
    
    // âœ… Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Background Fetch)
    func application(_ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable : Any], fetchCompletionHandler completionHandler: @escaping (UIBackgroundFetchResult) -> Void) {
        print("ðŸ“© Received remote notification: \(userInfo)")
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        NotificationService.shared.handleRemoteNotification(userInfo: userInfo)
        
        completionHandler(.newData)
    }

    // MARK: - UNUserNotificationCenterDelegate

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        if #available(iOS 14.0, *) {
            completionHandler([.banner, .list, .sound, .badge])
        } else {
            completionHandler([.alert, .sound, .badge])
        }
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        didReceive response: UNNotificationResponse,
        withCompletionHandler completionHandler: @escaping () -> Void
    ) {
        NotificationService.shared.handle(response: response)
        completionHandler()
    }
}
